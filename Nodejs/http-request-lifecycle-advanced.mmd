flowchart TD
    Start([ğŸŒ Client Sends HTTP Request]) --> TLScheck{ğŸ” HTTPS?}

    TLScheck -->|Yes| TLS1[ğŸ¤ TLS Handshake<br/>ClientHello ServerHello<br/>ALPN selects HTTP version]
    TLS1 --> TLS2[ğŸ”‘ TLS Key Exchange<br/>Certificate Verification]
    TLS2 --> TLS3[ğŸ›¡ï¸ Encrypted TCP Stream<br/>Established]
    TLS3 --> NetEntry
    TLScheck -->|No| NetEntry

    NetEntry[ğŸ“¦ Network Packet Arrives<br/>NIC to Kernel Network Stack] --> TCP
    TCP[ğŸ”Œ TCP Processing<br/>Connection Established<br/>Socket ESTABLISHED] --> KernBuf
    KernBuf[ğŸ’¾ Kernel Receive Buffer<br/>Stores Incoming Bytes] --> Ready
    Ready[ğŸ“¢ Kernel Marks Socket Readable<br/>epoll kqueue IOCP notified] --> PollPhase

    PollPhase[âš¡ Event Loop Poll Phase<br/>Ready Socket Returned] --> LibuvRead
    LibuvRead[ğŸ“– libuv Reads from Socket<br/>Non Blocking] --> HTTPParser
    HTTPParser[ğŸ” llhttp Parsing<br/>Method URL Version Headers] --> ParserDecision{ğŸ“¦ Body Exists?}

    ParserDecision -->|Yes| BodyStream[ğŸ”„ Streaming Body Parsing<br/>Chunk by Chunk<br/>Backpressure Aware]
    ParserDecision -->|No| CreateReqRes
    BodyStream --> CreateReqRes

    CreateReqRes[ğŸ¯ Create IncomingMessage req<br/>and ServerResponse res] --> EmitRequest
    EmitRequest[ğŸš€ Emit request Event<br/>and Call Handler] --> Handler

    Handler[ğŸ’» User Handler Executes] --> Microtasks
    Microtasks[ğŸ§  Microtasks Run<br/>nextTick Promises queueMicrotask] --> AsyncOps

    AsyncOps{ğŸ”¥ Async Operations?} -->|Yes| ReturnToLoop[â³ Event Loop Waits<br/>for DB IO Timers Workers]
    AsyncOps -->|No| PrepareResponse

    ReturnToLoop --> Microtasks
    ReturnToLoop --> PrepareResponse

    PrepareResponse[ğŸ“ Prepare Response<br/>Set Headers Write End] --> BackpressureCheck

    BackpressureCheck{â™»ï¸ Write Buffer Full?} -->|Yes| PauseReads[â¸ï¸ Pause Socket Reads<br/>Apply Backpressure]
    PauseReads --> DrainEvent[ğŸ”ˆ drain Event<br/>Resume Writes] --> BackpressureCheck
    BackpressureCheck -->|No| WriteSocket

    WriteSocket[ğŸ“¡ libuv Write to Socket<br/>Non Blocking] --> TLSApply{ğŸ” TLS Encryption?}

    TLSApply -->|Yes| TLSEncode[ğŸ”’ TLS Record Encoding] --> KernelSend
    TLSApply -->|No| KernelSend

    KernelSend[âš™ï¸ Kernel TCP Stack<br/>Segmentation and Checksums] --> NetOut
    NetOut[ğŸŒ Packets Sent to Client] --> Completion

    Completion[ğŸ res.end Completed<br/>and Flushed] --> ConnDecision{ğŸ”€ Keep Alive?}

    ConnDecision -->|No| CloseTCP
    ConnDecision -->|Yes HTTP/1.1| IdleReuse[â™»ï¸ Keep Alive<br/>Idle Wait for Next Request]
    ConnDecision -->|Yes HTTP/2| H2Stream[ğŸ“¶ HTTP/2 Multiplexing<br/>Multiple Streams]

    CloseTCP[ğŸ”’ FIN ACK TCP Close<br/>Socket CLOSED] --> CloseCallbacks
    IdleReuse --> Ready
    H2Stream --> Ready

    CloseCallbacks[ğŸ—‘ï¸ Close Callbacks Phase<br/>Cleanup FD Free Buffers] --> End
    End([âœ¨ End of Lifecycle])

    style Start fill:#C8E6C9,stroke:#2E7D32,stroke-width:3px
    style End fill:#FFCDD2,stroke:#C62828,stroke-width:3px
    style TLScheck fill:#FFF9C4,stroke:#F57F17,stroke-width:2px
    style TLS1 fill:#E1F5FE,stroke:#0288D1,stroke-width:2px
    style TLS2 fill:#E1F5FE,stroke:#0288D1,stroke-width:2px
    style TLS3 fill:#E1F5FE,stroke:#0288D1,stroke-width:2px
    style NetEntry fill:#E1F5FF,stroke:#0288D1,stroke-width:2px
    style TCP fill:#E1F5FF,stroke:#0288D1,stroke-width:2px
    style KernBuf fill:#E1F5FF,stroke:#0288D1,stroke-width:2px
    style Ready fill:#E1F5FF,stroke:#0288D1,stroke-width:2px
    style PollPhase fill:#FFF4E1,stroke:#F57C00,stroke-width:3px
    style LibuvRead fill:#FFF4E1,stroke:#F57C00,stroke-width:2px
    style HTTPParser fill:#FFF4E1,stroke:#F57C00,stroke-width:2px
    style ParserDecision fill:#FFF9C4,stroke:#F57F17,stroke-width:2px
    style BodyStream fill:#FFF4E1,stroke:#F57C00,stroke-width:2px
    style CreateReqRes fill:#FFF4E1,stroke:#F57C00,stroke-width:2px
    style EmitRequest fill:#FFF4E1,stroke:#F57C00,stroke-width:2px
    style Handler fill:#E8F5E9,stroke:#388E3C,stroke-width:3px
    style Microtasks fill:#E1BEE7,stroke:#8E24AA,stroke-width:2px
    style AsyncOps fill:#FFF9C4,stroke:#F57F17,stroke-width:2px
    style ReturnToLoop fill:#E1F5FE,stroke:#0288D1,stroke-width:2px
    style PrepareResponse fill:#E8F5E9,stroke:#388E3C,stroke-width:2px
    style BackpressureCheck fill:#FFF9C4,stroke:#F57F17,stroke-width:2px
    style PauseReads fill:#FFCCBC,stroke:#E64A19,stroke-width:2px
    style DrainEvent fill:#C8E6C9,stroke:#2E7D32,stroke-width:2px
    style WriteSocket fill:#FCE4EC,stroke:#C2185B,stroke-width:2px
    style TLSApply fill:#FFF9C4,stroke:#F57F17,stroke-width:2px
    style TLSEncode fill:#E1F5FE,stroke:#0288D1,stroke-width:2px
    style KernelSend fill:#FCE4EC,stroke:#C2185B,stroke-width:2px
    style NetOut fill:#FCE4EC,stroke:#C2185B,stroke-width:2px
    style Completion fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px
    style ConnDecision fill:#FFF9C4,stroke:#F57F17,stroke-width:2px
    style CloseTCP fill:#FFCDD2,stroke:#C62828,stroke-width:2px
    style IdleReuse fill:#C8E6C9,stroke:#2E7D32,stroke-width:2px
    style H2Stream fill:#B2DFDB,stroke:#00897B,stroke-width:2px
    style CloseCallbacks fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px

